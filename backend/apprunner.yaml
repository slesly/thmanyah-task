version: 1.0
runtime: nodejs18

build:
  commands:
    pre-build:
      - echo "Installing dependencies..."
      - npm ci
      - echo "Current directory:"
      - pwd
      - echo "Directory contents:"
      - ls -la
    build:
      - echo "Building application..."
      - export DB_HOST=thmanyah-db-1.cspi46cem801.us-east-1.rds.amazonaws.com
      - export DB_PORT=5432
      - export DB_USERNAME=postgres
      - export DB_PASSWORD=P5t6d8f10
      - export DB_DATABASE=thmanyahdb
      - export NODE_ENV=production
      - export PORT=3001
      - export ALLOWED_ORIGINS=http://localhost:3000,https://main.d19e30r7ro0wel.amplifyapp.com,https://agd9mkwapi.us-east-1.awsapprunner.com
      - npm run build
      - echo "Checking dist folder..."
      - ls -la dist/
      - echo "Checking if main.js exists:"
      - ls -la dist/main.js || echo "main.js not found"
      - echo "Checking if main.js.map exists:"
      - ls -la dist/main.js.map || echo "main.js.map not found"

run:
  command: DB_HOST=thmanyah-db-1.cspi46cem801.us-east-1.rds.amazonaws.com DB_PORT=5432 DB_USERNAME=postgres DB_PASSWORD=P5t6d8f10 DB_DATABASE=thmanyahdb NODE_ENV=production PORT=3001 ALLOWED_ORIGINS=http://localhost:3000,https://main.d19e30r7ro0wel.amplifyapp.com,https://agd9mkwapi.us-east-1.awsapprunner.com node dist/main.js
  network:
    port: 3001
